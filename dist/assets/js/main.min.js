import"./firebase.min.js";import{getDatabase,ref,set,child,get}from"https://www.gstatic.com/firebasejs/9.8.4/firebase-database.js";import Webcam from"./webcam-easy.min.js";import QrScanner from"./qr-scanner.min.js";const form=document.querySelector("#registerForm"),stepProgress=document.querySelectorAll(".step"),formStep=document.querySelectorAll(".form-step"),snapShot=document.querySelector("#take-snapshot"),savePhoto=document.querySelector("#save-photo"),retakePhoto=document.querySelector("#retake-photo"),backBtnInformation=document.querySelector("#back-information"),backBtnIdentity=document.querySelector("#back-identity"),submitBtn=document.querySelector("#submit-btn"),openScan=document.querySelector("#open-scanner"),closeScan=document.querySelector("#close-scanner"),closeResult=document.querySelectorAll(".close-result"),fileSelector=document.querySelector("#upload-qr"),webcamElement=document.querySelector("#webcam"),canvasElement=document.querySelector("#canvas");let webcam;webcamElement&&canvasElement&&(webcam=new Webcam(webcamElement,"user",canvasElement));let active=1;const paths={index:"index.html",register:"register.html",download:"download.html",recognition:"recognition.html",result:"result.html"},{index:index,register:register,download:download,recognition:recognition,result:result}=paths,idle=()=>{let e=0,t=setInterval((()=>{e+=1,120===e&&(clearInterval(t),window.location.reload())}),1e3);document.addEventListener("mousemove",(()=>e=0)),document.addEventListener("keydown",(()=>e=0))},generateID=()=>`${(new Date).getFullYear()}-${Math.random().toString(36).slice(-5)}`,generateQRCode=()=>{new QRCode(document.querySelector("#qrcode"),Storage.getRegisteredUser().userID),document.querySelector("#qr-name").innerHTML=`${Storage.getRegisteredUser().firstName.toUpperCase()} ${Storage.getRegisteredUser().lastName.toUpperCase()}`},displayErrMsg=(e,t)=>{const r=document.createElement("div");r.classList.add("invalid-feedback"),r.innerHTML=e,t.classList.add("invalid"),t.focus(),t.nextElementSibling.after(r)},resetErrMsg=()=>{document.querySelectorAll(".invalid-feedback").forEach((e=>e.remove())),document.querySelectorAll(".form-control").forEach((e=>e.classList.remove("invalid")))},nextStep=()=>{active++,active>stepProgress.length&&(active=stepProgress.length),updateProgress()},prevStep=()=>{active--,active<1&&(active=1),updateProgress()},updateProgress=()=>{stepProgress.forEach(((e,t)=>{t===active-1?(e.classList.add("active"),formStep[t].hidden=!1,formStep[t].classList.add("active")):(e.classList.remove("active"),formStep[t].classList.remove("active"),formStep[t].hidden=!0)}))},openWebcam=()=>{webcam.start().then((e=>{console.log(e,"webcam started"),webcamElement.hidden=!1,snapShot&&(snapShot.hidden=!1)})).catch((e=>{console.error(e),Toastify({text:"Permission denied. Allow me to use your camera.",duration:3e3,close:!0,gravity:"top",position:"center",stopOnFocus:!0,backgroundColor:"#d33329"}).showToast(),setTimeout((()=>{window.location.reload()}),3e3)}))},offWebcam=()=>{webcam.stop(),webcamElement.hidden=!0,canvasElement.hidden=!0,snapShot.hidden=!0},scanQr=()=>{const e=document.querySelector("#qr-video");e.hidden=!1;const t=new QrScanner(e,(r=>{document.querySelector(".loading-screen").hidden=!1,t.destroy(),e.hidden=!0,ProfileImage.readUser(r.data)}),{highlightScanRegion:!0,highlightCodeOutline:!0});return t},models=()=>{Promise.all([faceapi.nets.faceLandmark68Net.loadFromUri("models"),faceapi.nets.faceRecognitionNet.loadFromUri("models"),faceapi.nets.ssdMobilenetv1.loadFromUri("models")]).then(start)},start=async()=>{const e=await loadImage();if(e){const t=new faceapi.FaceMatcher(e,.5);document.querySelector(".loading-screen").hidden=!0,openWebcam();let r=5;setInterval((async()=>{if(r--,r>=1&&(document.querySelector("#count").innerHTML=r),0===r){document.querySelector(".overlay-timer").style.setProperty("--bg-color","transparent"),document.querySelector("#count").hidden=!0,webcam.snap();const e=await faceapi.detectSingleFace(canvasElement).withFaceLandmarks().withFaceDescriptor();if(e){const r={width:canvasElement.width,height:canvasElement.height},o=faceapi.resizeResults(e,r),a={result:t.findBestMatch(o.descriptor).label,image:Storage.getResult().image};Storage.setResult(a),window.location.href=result}else webcam.stop(),Toastify({text:"No faces detected. Please try again.",duration:3e3,close:!0,gravity:"top",position:"center",stopOnFocus:!0,backgroundColor:"#d33329"}).showToast(),setTimeout((()=>{Storage.removeResult(),window.location.href=index}),3e3)}}),1e3)}},loadImage=async()=>{const e=await faceapi.fetchImage(Storage.getResult().image),t=await faceapi.detectSingleFace(e).withFaceLandmarks().withFaceDescriptor();if(t){const e=[t.descriptor];return new faceapi.LabeledFaceDescriptors(`${Storage.getResult().firstName} ${Storage.getResult().lastName}`,e)}Toastify({text:"There were no faces in the picture based on the QR code. \n      You must use the QR code provided.",duration:3e3,close:!0,gravity:"top",position:"center",stopOnFocus:!0,backgroundColor:"#d33329"}).showToast(),setTimeout((()=>{Storage.removeResult(),window.location.href=index}),3e3)};class User{constructor(e,t,r,o){this.userID=e,this.firstName=t,this.lastName=r,this.email=o}}class ProfileImage extends User{constructor(e,t,r,o,a){super(e,t,r,o),this.image=a}addUser(){const e=getDatabase(),t=ref(e,`users/${this.userID}`);set(t,{firstName:this.firstName,lastName:this.lastName,email:this.email,image:this.image}).then((()=>window.location.href=download)).catch((e=>console.error(e)))}static readUser(e){const t=getDatabase(),r=ref(t);get(child(r,`users/${e}`)).then((e=>{if(e.exists()){const t=e.val();Storage.setResult(t),window.location.href=recognition}else document.querySelector(".loading-screen").hidden=!0,Toastify({text:"No Match Found.",duration:3e3,close:!0,gravity:"top",position:"center",stopOnFocus:!0,backgroundColor:"#d33329"}).showToast(),document.querySelector("#illustration").hidden=!1,openScan.hidden=!1,document.querySelector("#upload-qr-btn").style.display="block",closeScan.hidden=!0})).catch((e=>console.error(e)))}}class Storage{static setRegisteredUser(e){localStorage.setItem("user",JSON.stringify(e))}static getRegisteredUser(){const e=JSON.parse(localStorage.getItem("user"));if(null!==e)return e}static checkRegisteredUser(){null===JSON.parse(localStorage.getItem("user"))&&(window.location.href=register)}static setResult(e){localStorage.setItem("result",JSON.stringify(e))}static getResult(){const e=JSON.parse(localStorage.getItem("result"));if(null!==e)return e}static checkResult(){null===JSON.parse(localStorage.getItem("result"))&&(window.location.href=index)}static removeResult(){localStorage.removeItem("result")}}if(form&&(form.addEventListener("submit",(e=>{e.preventDefault();const t=document.querySelector("#firstName"),r=document.querySelector("#lastName"),o=document.querySelector("#email");let a;if(""===t.value||0===t.value.length)resetErrMsg(),a="Please enter your first name.",displayErrMsg(a,t);else if(""===r.value||0===r.value.length)resetErrMsg(),a="Please enter your last name.",displayErrMsg(a,r);else if(""===o.value||0===o.value.length)resetErrMsg(),a="Please enter your email address.",displayErrMsg(a,o);else{resetErrMsg();const e=new User(`${(new Date).getFullYear()}-${Math.random().toString(36).slice(-5)}`,t.value,r.value,o.value);Storage.setRegisteredUser(e),form.reset(),nextStep(),openWebcam()}})),snapShot&&snapShot.addEventListener("click",(()=>{let e=webcam.snap();webcamElement.hidden=!0,snapShot.hidden=!0,backBtnInformation.hidden=!0,canvasElement.hidden=!1,savePhoto.hidden=!1,retakePhoto.hidden=!1;const t=new ProfileImage(Storage.getRegisteredUser().userID,Storage.getRegisteredUser().firstName,Storage.getRegisteredUser().lastName,Storage.getRegisteredUser().email,e);Storage.setRegisteredUser(t)})),savePhoto&&savePhoto.addEventListener("click",(()=>{document.querySelector("#avatar").src=Storage.getRegisteredUser().image,document.querySelector("#first-name").innerHTML=Storage.getRegisteredUser().firstName,document.querySelector("#last-name").innerHTML=Storage.getRegisteredUser().lastName,document.querySelector("#email-add").innerHTML=Storage.getRegisteredUser().email,offWebcam(),nextStep()})),retakePhoto&&retakePhoto.addEventListener("click",(()=>{canvasElement.hidden=!0,savePhoto.hidden=!0,retakePhoto.hidden=!0,webcamElement.hidden=!1,snapShot.hidden=!1,backBtnInformation.hidden=!1})),backBtnInformation&&backBtnInformation.addEventListener("click",(()=>{offWebcam(),firstName.value=Storage.getRegisteredUser().firstName,lastName.value=Storage.getRegisteredUser().lastName,email.value=Storage.getRegisteredUser().email,prevStep()})),backBtnIdentity&&backBtnIdentity.addEventListener("click",(()=>{prevStep(),openWebcam(),savePhoto.hidden=!0,retakePhoto.hidden=!0,backBtnInformation.hidden=!1})),submitBtn&&submitBtn.addEventListener("click",(()=>{document.querySelector(".loading-screen").hidden=!1;new ProfileImage(Storage.getRegisteredUser().userID,Storage.getRegisteredUser().firstName,Storage.getRegisteredUser().lastName,Storage.getRegisteredUser().email,Storage.getRegisteredUser().image).addUser()}))),openScan&&openScan.addEventListener("click",(()=>{document.querySelector("#illustration").hidden=!0,openScan.hidden=!0,document.querySelector("#upload-qr-btn").style.display="none",closeScan.hidden=!1,scanQr().start(),idle()})),fileSelector&&fileSelector.addEventListener("change",(()=>{const e=fileSelector.files[0];e&&QrScanner.scanImage(e,{returnDetailedScanResult:!0}).then((e=>ProfileImage.readUser(e.data))).catch((e=>{Toastify({text:`${e}. Please try again.`,duration:3e3,close:!0,gravity:"top",position:"center",stopOnFocus:!0,backgroundColor:"#d33329"}).showToast()}))})),closeScan&&closeScan.addEventListener("click",(()=>window.location.reload())),closeResult&&closeResult.forEach((e=>{e.addEventListener("click",(()=>{Storage.removeResult(),window.location.href=index}))})),window.location.pathname===`/${download}`){Storage.checkRegisteredUser(),new QRCode(document.querySelector("#qrcode"),Storage.getRegisteredUser().userID),document.querySelector("#qr-name").innerHTML=`${Storage.getRegisteredUser().firstName.toUpperCase()} ${Storage.getRegisteredUser().lastName.toUpperCase()}`,setTimeout((()=>{document.querySelector(".loading-screen").hidden=!0}),2e3);document.querySelector("#download-qr").addEventListener("click",(()=>{html2canvas(document.querySelector("#qr-code-wrapper")).then((e=>{const t=e.toDataURL(),r=`${Storage.getRegisteredUser().firstName} ${Storage.getRegisteredUser().lastName}.jpg`,o=document.createElement("a");"string"==typeof o.download?(o.href=t,o.download=r,document.body.appendChild(o),o.click(),document.body.removeChild(o)):window.open(t),localStorage.removeItem("user"),window.location.href=index}))}))}window.location.pathname===`/${recognition}`&&(Storage.checkResult(),Promise.all([faceapi.nets.faceLandmark68Net.loadFromUri("models"),faceapi.nets.faceRecognitionNet.loadFromUri("models"),faceapi.nets.ssdMobilenetv1.loadFromUri("models")]).then(start)),window.location.pathname===`/${result}`&&(Storage.checkResult(),"unknown"===Storage.getResult().result?document.querySelector('[data-result="failed"]').hidden=!1:(document.querySelector("#output-img").src=Storage.getResult().image,document.querySelector("#output-name").innerHTML=Storage.getResult().result,document.querySelector('[data-result="success"]').hidden=!1));
//# sourceMappingURL=main.min.js.map